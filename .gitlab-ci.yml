# This build file heavily uses template features from YAML so it is generic
# enough for any Bob project. Don't modify it unless you know what you're
# doing.


# Definition of our build pipeline
stages:
  - build
  - test
  - docs
  - wheels
  - conda
  - deploy


# ---------
# Templates
# ---------

# Template for the build stage
# Needs to run on all supported architectures, platforms and python versions
.build_template: &build_job
  stage: build
  before_script:
    - git clean -ffdx
    - mkdir _ci
    - curl --silent "https://gitlab.idiap.ch/bob/bob.admin/raw/master/gitlab/install.sh" > _ci/install.sh
    - chmod 755 _ci/install.sh
    - ./_ci/install.sh _ci #updates
    - ./_ci/before_build.sh
  script:
    - ./_ci/build.sh
  after_script:
    - ./_ci/after_build.sh
  artifacts:
    expire_in: 1 week
    paths:
      - _ci/
      - dist/
      - sphinx/


# Template for the test stage - re-installs from uploaded wheels
# Needs to run on all supported architectures, platforms and python versions
.test_template: &test_job
  stage: test
  before_script:
    - ./_ci/install.sh _ci #updates
    - ./_ci/before_test.sh
  script:
    - ./_ci/test.sh
  after_script:
    - ./_ci/after_test.sh


# Template for the wheel uploading stage
# Needs to run against one supported architecture, platform and python version
.wheels_template: &wheels_job
  stage: wheels
  environment: intranet
  only:
    - master
    - /^v\d+\.\d+\.\d+([abc]\d*)?$/  # PEP-440 compliant version (tags)
  before_script:
    - ./_ci/install.sh _ci #updates
    - ./_ci/before_wheels.sh
  script:
    - ./_ci/wheels.sh
  after_script:
    - ./_ci/after_wheels.sh


# Template for (latest) documentation upload stage
# Only one real job needs to do this
.docs_template: &docs_job
  stage: docs
  environment: intranet
  only:
    - master
  before_script:
    - ./_ci/install.sh _ci #updates
    - ./_ci/before_docs.sh
  script:
    - ./_ci/docs.sh
  after_script:
    - ./_ci/after_docs.sh

# Template for the conda package creation stage
.conda_template: &conda_job
  stage: conda
  variables: &conda_variables
    UPLOAD_URL: "http://www.idiap.ch/software/bob/conda"
    CONDA_NPY: "111"
    PYTHONUNBUFFERED: "1"
    CONDA_ENVS_PATH: "conda-env"
    CONDA_BLD_PATH: "conda-env"
  before_script: &conda_before_script
    - export PATH=/opt/miniconda/bin:$PATH
    - export BOB_PACKAGE_VERSION=`cat version.txt`
    - conda config --set always_yes true
    - conda config --set show_channel_urls true
    - conda config --add channels defaults
    - conda config --add channels ${UPLOAD_URL}
    - conda config --set ssl_verify false
    - conda install --quiet --yes curl
    - conda update -n root --yes conda conda-build
    - conda clean --lock
    - conda info
  image: continuumio/conda_builder_linux
  cache:
    key: "$CI_BUILD_NAME"
    paths:
      - conda-env/.pkgs/*.tar.bz2
      - conda-env/.pkgs/urls.txt
      - conda-env/src_cache

conda_intranet_linux_27:
  <<: *conda_job
  before_script:
    - export PATH=/opt/miniconda/bin:$PATH
    - conda config --set always_yes true
    - conda config --set show_channel_urls true
    - conda config --add channels defaults
    - conda config --add channels ${UPLOAD_URL}
    - conda config --add channels ${UPLOAD_URL}/label/beta
    - conda config --set ssl_verify false
    - conda update -n root conda --quiet --yes
    - conda clean --lock
    - conda info
    - export BOB_PACKAGE_VERSION=`cat version.txt`
    - ./channel_support.py ${UPLOAD_URL}/label/beta ${CI_PROJECT_NAME} ${BOB_PACKAGE_VERSION} ${PYTHON_VERSION} -u --log ./build_number.txt
    - export BOB_BUILD_NUMBER=`head -n 1 build_number.txt`
  script:
    - conda-build --python=${PYTHON_VERSION} conda.recipe
    - curl --location --silent --show-error --user "${DOCUSER}:${DOCPASS}" --upload-file `conda-build --python=${PYTHON_VERSION} conda.recipe --output` "${UPLOAD_URL}-upload/label/beta/${OS_SLUG}/"
    - for url in `tail -n +2 build_number.txt`; do curl --location --silent --show-error --user "${DOCUSER}:${DOCPASS}" -X DELETE "${url/${UPLOAD_URL}/${UPLOAD_URL}-upload}"; done
    # TODO: delete old beta packages
  variables:
    <<: *conda_variables
    PYTHON_VERSION: "2.7"
    OS_SLUG: "linux-64"
  tags:
    - docker
  environment: intranet
  only:
    - master
    - condapackage
  except:
    - /^v\d+\.\d+\.\d+([abc]\d*)?$/  # PEP-440 compliant version (tags)

conda_internet_linux_27:
  <<: *conda_job
  script:
    - conda-build --python=${PYTHON_VERSION} conda.recipe
    - curl --location --silent --show-error --user "${DOCUSER}:${DOCPASS}" --upload-file `conda-build --python=${PYTHON_VERSION} conda.recipe --output` "${UPLOAD_URL}-upload/${OS_SLUG}/"
  variables:
    <<: *conda_variables
    PYTHON_VERSION: "2.7"
    OS_SLUG: "linux-64"
  tags:
    - docker
  environment: internet
  only:
    - /^v\d+\.\d+\.\d+([abc]\d*)?$/  # PEP-440 compliant version (tags)
  except:
    - branches

# conda_macosx_35:
#   <<: *conda_job
#   variables:
#     <<: *conda_variables
#     PYTHON_VERSION: "3.5"
#     OS_SLUG: "osx-64"
#   tags:
#     - conda-macosx

# Template for the deployment stage - re-installs from uploaded wheels
# Needs to run on a single architecture only
# Will deploy your package to PyPI and other required services
# Only runs for tags
.deploy_template: &deploy_job
  stage: deploy
  environment: internet
  only:
    - /^v\d+\.\d+\.\d+([abc]\d*)?$/  # PEP-440 compliant version (tags)
  except:
    - branches
  before_script:
    - ./_ci/install.sh _ci #updates
    - ./_ci/before_deploy.sh
  script:
    - ./_ci/deploy.sh
  after_script:
    - ./_ci/after_deploy.sh


# -------------
# Build Targets
# -------------

# Linux + Python 2.7: Builds, tests, uploads wheel and deploys (if needed)
# build_linux_27:
#   <<: *build_job
#   variables: &linux_27_build_variables
#     PYTHON_VERSION: "2.7"
#     WHEEL_TAG: "py27"
#   tags:
#     - conda-linux

# test_linux_27:
#   <<: *test_job
#   variables: *linux_27_build_variables
#   dependencies:
#     - build_linux_27
#   tags:
#     - conda-linux

# wheels_linux_27:
#   <<: *wheels_job
#   variables: *linux_27_build_variables
#   dependencies:
#     - build_linux_27
#   tags:
#     - conda-linux

# deploy_linux_27:
#   <<: *deploy_job
#   variables: *linux_27_build_variables
#   dependencies:
#     - build_linux_27
#   tags:
#     - conda-linux


# # Linux + Python 3.4: Builds and tests
# build_linux_34:
#   <<: *build_job
#   variables: &linux_34_build_variables
#     PYTHON_VERSION: "3.4"
#     WHEEL_TAG: "py3"
#   tags:
#     - conda-linux

# test_linux_34:
#   <<: *test_job
#   variables: *linux_34_build_variables
#   dependencies:
#     - build_linux_34
#   tags:
#     - conda-linux


# # Linux + Python 3.5: Builds, tests and uploads wheel
# build_linux_35:
#   <<: *build_job
#   variables: &linux_35_build_variables
#     PYTHON_VERSION: "3.5"
#     WHEEL_TAG: "py3"
#   tags:
#     - conda-linux

# test_linux_35:
#   <<: *test_job
#   variables: *linux_35_build_variables
#   dependencies:
#     - build_linux_35
#   tags:
#     - conda-linux

# wheels_linux_35:
#   <<: *wheels_job
#   variables: *linux_35_build_variables
#   dependencies:
#     - build_linux_35
#   tags:
#     - conda-linux

# docs_linux_35:
#   <<: *docs_job
#   variables: *linux_35_build_variables
#   dependencies:
#     - build_linux_35
#   tags:
#     - conda-linux


# # Mac OSX + Python 2.7: Builds and tests
# build_macosx_27:
#   <<: *build_job
#   variables: &macosx_27_build_variables
#     PYTHON_VERSION: "2.7"
#     WHEEL_TAG: "py27"
#   tags:
#     - conda-macosx

# test_macosx_27:
#   <<: *test_job
#   variables: *macosx_27_build_variables
#   dependencies:
#     - build_macosx_27
#   tags:
#     - conda-macosx


# # Mac OSX + Python 3.4: Builds and tests
# build_macosx_34:
#   <<: *build_job
#   variables: &macosx_34_build_variables
#     PYTHON_VERSION: "3.4"
#     WHEEL_TAG: "py3"
#   tags:
#     - conda-macosx

# test_macosx_34:
#   <<: *test_job
#   variables: *macosx_34_build_variables
#   dependencies:
#     - build_macosx_34
#   tags:
#     - conda-macosx


# # Mac OSX + Python 3.5: Builds and tests
# build_macosx_35:
#   <<: *build_job
#   variables: &macosx_35_build_variables
#     PYTHON_VERSION: "3.5"
#     WHEEL_TAG: "py3"
#   tags:
#     - conda-macosx

# test_macosx_35:
#   <<: *test_job
#   variables: *macosx_35_build_variables
#   dependencies:
#     - build_macosx_35
#   tags:
#     - conda-macosx
